<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <title>Панель </title>
    <link rel="stylesheet" href="css\style-panel.css">
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>

<body>
    <header>
        <table style="width: 100%;">
            <tr>
                <td nowrap>
                    <label class="input-file">
                        <input type="file" name="file" id="fileToLoad" accept=".txt" onchange="loadFileAsText()">
                        <span class="input-file-btn">Выберите файл</span>
                        <span class="input-file-text">Укажите файл со списком игроков</span>
                    </label>

                </td>
            </tr>
        </table>
        <table style="width: 100%;" id="main-buttons">
            <tr>
                <td>
                    Показывать панель игроков
                </td>
                <td style="width: 80px">
                    <div class="button r button-1" id="button-panel">
                        <input type="checkbox" class="checkbox" checked>
                        <div class="knobs"></div>
                        <div class="layer"></div>
                    </div>
                </td>
            </tr>
            <tr hidden>
                <td>
                    Показывать игровые роли
                </td>
                <td>
                    <div class="button r button-1" id="button-roles">
                        <input type="checkbox" class="checkbox">
                        <div class="knobs"></div>
                        <div class="layer"></div>
                    </div>
                </td>
            </tr>
        </table>
    </header>
    <div class="main">
        <table class="player-table">
            <tr style="background-color: rgb(31,30,31);">
                <td>
                    №
                </td>
                <td>
                    Никнейм
                </td>
                <td colspan="3">
                    Статус
                </td>
                <td></td>
                <td colspan="3">
                    Роль
                </td>
            </tr>

            <tr class="player" id="player_1">
                <td class="number">
                    <p>1</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_2">
                <td class="number">
                    <p>2</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_3">
                <td class="number">
                    <p>3</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_4">
                <td class="number">
                    <p>4</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_5">
                <td class="number">
                    <p>5</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_6">
                <td class="number">
                    <p>6</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_7">
                <td class="number">
                    <p>7</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_8">
                <td class="number">
                    <p>8</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_9">
                <td class="number">
                    <p>9</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>
            <tr class="player" id="player_10">
                <td class="number">
                    <p>10</p>
                </td>
                <td class="players">
                    <select class="player-list"></select>
                </td>
                <td class="s-button killed-button">
                    <div onclick="changeStatus(this, 'killed')"></div>
                </td>
                <td class="s-button voted-button">
                    <div onclick="changeStatus(this, 'voted')"></div>
                </td>
                <td class="s-button deleted-button">
                    <div onclick="changeStatus(this, 'deleted')"></div>
                </td>
                <td></td>
                <td class="s-button don-button">
                    <div onclick="changeRole(this, 'don')"></div>
                </td>
                <td class="s-button mafia-button">
                    <div onclick="changeRole(this, 'mafia')"></div>
                </td>
                <td class="s-button sheriff-button">
                    <div onclick="changeRole(this, 'sheriff')"></div>
                </td>
            </tr>

            <tr>
                <td></td>
                <td class="players"><button onclick="sendAllData()">Отправить</button></td>
                <td colspan="3">
                    <button onclick="clearStatus()">Сбросить</button>
                </td>
                <td></td>
                <td colspan="3">
                    <button onclick="clearRole()">Сбросить</button>
                </td>
            </tr>
        </table>
    </div>
    <footer>

    </footer>
    <script>
        data = "Ник1|Ник2";
        player_list = data.split('|');

        const ps = new BroadcastChannel('panel_status');
        const pl = new BroadcastChannel('player_list');
        const cl = new BroadcastChannel('class_list');

        $(document).ready(function() {
            $('.main').hide();
            $('#main-buttons').hide();
            getPlayerList(player_list);
        });

        function loadFileAsText() {
            var fileToLoad = document.getElementById("fileToLoad").files[0];

            var fileReader = new FileReader();
            fileReader.onload = function(fileLoadedEvent) {
                var textFromFileLoaded = fileLoadedEvent.target.result;
                getPlayerList(textFromFileLoaded.split('\r\n'));
            };
            fileReader.readAsText(fileToLoad, "UTF-8");
            $('.main').show();
            $('#main-buttons').show();
        }

        function getPlayerList(playerArray) {
            document.querySelectorAll('.player-list').forEach((element, index, array) => {
                $(element).empty();
                playerArray.forEach(player => {
                    element.add(new Option(player.trim()));
                });
                $(element).children('option').eq(index).attr('selected', 'selected');
            });
        }

        function changeStatus(object, status) {
            element = object.parentElement.parentElement;
            if (element.classList.contains(status)) {
                element.classList.remove(status);
                element.classList.remove('dead');
            } else {
                if (element.classList.contains('dead')) {
                    element.classList.remove('killed');
                    element.classList.remove('voted');
                    element.classList.remove('deleted');
                } else {
                    element.classList.add('dead')
                }
                element.classList.add(status);
            }
            classes = element.id + '|' + element.classList.value;
            cl.postMessage(classes);
        }

        function changeRole(object, role) {
            element = object.parentElement.parentElement;
            if (element.classList.contains(role)) {
                element.classList.remove(role);
            } else {
                element.classList.remove('don');
                element.classList.remove('mafia');
                element.classList.remove('sheriff');
                element.classList.add(role);
            }
            classes = element.id + '|' + element.classList.value;
            cl.postMessage(classes);
        }


        function clearStatus() {
            document.querySelectorAll('.killed').forEach((item, index, array) => {
                item.classList.remove('killed');
            });
            document.querySelectorAll('.voted').forEach((item, index, array) => {
                item.classList.remove('voted');
            });
            document.querySelectorAll('.deleted').forEach((item, index, array) => {
                item.classList.remove('deleted');
            });
            document.querySelectorAll('.dead').forEach((item, index, array) => {
                item.classList.remove('dead');
            });
            document.querySelectorAll('.player').forEach((element, index, array) => {
                player = element.id + '|' + element.classList.value;
                cl.postMessage(player);
            });
        }

        function clearRole() {
            document.querySelectorAll('.don').forEach((item, index, array) => {
                item.classList.remove('don');
            });
            document.querySelectorAll('.mafia').forEach((item, index, array) => {
                item.classList.remove('mafia');
            });
            document.querySelectorAll('.sheriff').forEach((item, index, array) => {
                item.classList.remove('sheriff');
            });
            document.querySelectorAll('.player').forEach((element, index, array) => {
                player = element.id + '|' + element.classList.value;
                cl.postMessage(player);
            });
        }

        $('#button-panel').click(function() {
            if ($('#button-panel').find('.checkbox')[0].checked) {
                ps.postMessage('body|visible');
            } else {
                ps.postMessage('body|');
            }
        });

        $('#button-roles').click(function() {
            if ($('#button-roles').find('.checkbox')[0].checked) {
                ps.postMessage('footer|show-roles');
            } else {
                ps.postMessage('footer|');
            }

        });

        $('.player-table select').on('change', function() {
            player = $(this).parents('.player')[0].id + '|' + $(this).find(":selected").val();
            pl.postMessage(player);
        });

        function sendAllData() {
            document.querySelectorAll('.player').forEach((element, index, array) => {
                item = element.querySelectorAll('.player-list')[0];
                player = element.id + '|' + $(item[item.selectedIndex]).text();

                pl.postMessage(player);
            });
        }
        $('.input-file input[type=file]').on('change', function() {
            let file = this.files[0];
            $(this).closest('.input-file').find('.input-file-text').html(file.name);
        });
    </script>

</body>

</html>